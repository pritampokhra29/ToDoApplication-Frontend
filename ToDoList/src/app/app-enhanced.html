<!-- Enhanced ToDo Application Template -->
<div class="app-container">
  <!-- Header -->
  <header class="app-header" *ngIf="isLoggedIn">
    <div class="header-content">
      <h1>{{ title() }}</h1>
      <div class="user-info">
        <span class="welcome">Welcome, {{ currentUser?.username }}!</span>
        <span class="role-badge" [class]="'role-' + currentUser?.role?.toLowerCase()">
          {{ currentUser?.role }}
        </span>
        <button class="btn btn-outline" (click)="logout()">Logout</button>
      </div>
    </div>
    
    <!-- Navigation -->
    <nav class="app-nav">
      <button 
        class="nav-btn" 
        [class.active]="currentView === 'tasks'"
        (click)="setView('tasks')">
        <i class="icon">ğŸ“‹</i> Tasks
      </button>
      <button 
        class="nav-btn" 
        [class.active]="currentView === 'dashboard'"
        (click)="setView('dashboard')">
        <i class="icon">ğŸ“Š</i> Dashboard
      </button>
      <button 
        *ngIf="isAdmin"
        class="nav-btn" 
        [class.active]="currentView === 'admin'"
        (click)="setView('admin')">
        <i class="icon">ğŸ‘¥</i> Admin
      </button>
    </nav>
  </header>

  <!-- Login Form -->
  <div class="login-container" *ngIf="!isLoggedIn">
    <div class="login-card">
      <h2>Login to ToDoList</h2>
      <form (ngSubmit)="login()" #loginForm="ngForm">
        <div class="form-group">
          <label for="username">Username:</label>
          <input 
            type="text" 
            id="username"
            name="username"
            [(ngModel)]="loginData.username" 
            required
            class="form-control"
            placeholder="Enter your username">
        </div>
        
        <div class="form-group">
          <label for="password">Password:</label>
          <input 
            type="password" 
            id="password"
            name="password"
            [(ngModel)]="loginData.password" 
            required
            class="form-control"
            placeholder="Enter your password">
        </div>
        
        <button type="submit" class="btn btn-primary" [disabled]="loading || !loginForm.form.valid">
          <span *ngIf="loading">ğŸ”„ Logging in...</span>
          <span *ngIf="!loading">ğŸ” Login</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content" *ngIf="isLoggedIn">
    
    <!-- Tasks View -->
    <div class="tasks-view" *ngIf="currentView === 'tasks'">
      
      <!-- Task Controls -->
      <div class="task-controls">
        <div class="controls-row">
          <button class="btn btn-primary" (click)="openTaskModal()">
            â• Add New Task
          </button>
          
          <!-- Search -->
          <div class="search-container">
            <input 
              type="text" 
              [(ngModel)]="filters.keyword"
              (input)="applyFilters()"
              placeholder="Search tasks..."
              class="search-input">
            <button class="btn btn-outline" (click)="clearFilters()">Clear</button>
          </div>
          
          <button class="btn btn-outline" (click)="showAdvancedFilters = !showAdvancedFilters">
            ğŸ” {{ showAdvancedFilters ? 'Hide' : 'Show' }} Filters
          </button>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" *ngIf="showAdvancedFilters">
          <div class="filter-row">
            <div class="filter-group">
              <label>Status:</label>
              <select [(ngModel)]="filters.status" (change)="applyFilters()" class="form-control">
                <option value="ALL">All</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Priority:</label>
              <select [(ngModel)]="filters.priority" (change)="applyFilters()" class="form-control">
                <option value="ALL">All</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Category:</label>
              <select [(ngModel)]="filters.category" (change)="applyFilters()" class="form-control">
                <option value="">All Categories</option>
                <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" *ngIf="selectedTasks.length > 0">
          <span class="selection-info">{{ selectedTasks.length }} task(s) selected</span>
          <button class="btn btn-sm" (click)="bulkUpdateStatus('PENDING')">ğŸ“ Mark Pending</button>
          <button class="btn btn-sm" (click)="bulkUpdateStatus('IN_PROGRESS')">â³ Mark In Progress</button>
          <button class="btn btn-sm" (click)="bulkUpdateStatus('COMPLETED')">âœ… Mark Completed</button>
          <button class="btn btn-outline btn-sm" (click)="clearSelection()">Clear Selection</button>
        </div>
      </div>

      <!-- Tasks Grid -->
      <div class="tasks-grid" *ngIf="filteredTasks.length > 0">
        <div 
          *ngFor="let task of filteredTasks; trackBy: trackByTaskId" 
          class="task-card"
          [class.selected]="selectedTasks.includes(task.id!)"
          [class.overdue]="isOverdue(task.dueDate!)"
          [class]="getStatusClass(task.status)">
          
          <div class="task-header">
            <div class="task-selection">
              <input 
                type="checkbox" 
                [checked]="selectedTasks.includes(task.id!)"
                (change)="toggleTaskSelection(task.id!)">
            </div>
            
            <div class="task-title-section">
              <h3 class="task-title">{{ task.title }}</h3>
              <div class="task-meta">
                <span class="priority-badge" [class]="getPriorityClass(task.priority!)">
                  {{ task.priority }}
                </span>
                <span class="status-badge" [class]="getStatusClass(task.status)">
                  {{ task.status.replace('_', ' ') }}
                </span>
                <span *ngIf="task.category" class="category-badge">{{ task.category }}</span>
              </div>
            </div>
            
            <div class="task-actions">
              <button class="btn-icon" (click)="openTaskModal(task)" title="Edit">âœï¸</button>
              <button class="btn-icon" (click)="deleteTask(task.id!)" title="Delete">ğŸ—‘ï¸</button>
            </div>
          </div>

          <div class="task-body" *ngIf="task.description">
            <p class="task-description">{{ task.description }}</p>
          </div>

          <div class="task-footer">
            <div class="task-dates">
              <div *ngIf="task.dueDate" class="due-date">
                <strong>Due:</strong> {{ formatDate(task.dueDate) }}
                <span *ngIf="isOverdue(task.dueDate)" class="overdue-label">âš ï¸ Overdue</span>
              </div>
              <div *ngIf="task.completionDate" class="completion-date">
                <strong>Completed:</strong> {{ formatDate(task.completionDate) }}
              </div>
            </div>

            <div class="task-assignment" *ngIf="task.assignedTo">
              <strong>Assigned to:</strong> {{ task.assignedTo.username }}
            </div>

            <div class="task-tags" *ngIf="task.tags && task.tags.length > 0">
              <span *ngFor="let tag of task.tags" class="tag">{{ tag }}</span>
            </div>

            <div class="status-actions">
              <button 
                *ngIf="task.status !== 'PENDING'"
                class="btn btn-sm btn-outline" 
                (click)="updateTaskStatus(task, 'PENDING')">
                ğŸ“ Pending
              </button>
              <button 
                *ngIf="task.status !== 'IN_PROGRESS'"
                class="btn btn-sm btn-warning" 
                (click)="updateTaskStatus(task, 'IN_PROGRESS')">
                â³ In Progress
              </button>
              <button 
                *ngIf="task.status !== 'COMPLETED'"
                class="btn btn-sm btn-success" 
                (click)="updateTaskStatus(task, 'COMPLETED')">
                âœ… Complete
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- No Tasks Message -->
      <div class="no-tasks" *ngIf="filteredTasks.length === 0 && !loading">
        <h3>No tasks found</h3>
        <p>{{ filters.keyword || filters.status !== 'ALL' || filters.priority !== 'ALL' || filters.category ? 'Try adjusting your filters or' : '' }} Create your first task to get started!</p>
        <button class="btn btn-primary" (click)="openTaskModal()">â• Add New Task</button>
      </div>
    </div>

    <!-- Dashboard View -->
    <div class="dashboard-view" *ngIf="currentView === 'dashboard'">
      <h2>ğŸ“Š Dashboard</h2>
      
      <div class="dashboard-stats" *ngIf="dashboardStats">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>{{ dashboardStats.totalTasks }}</h3>
            <p>Total Tasks</p>
          </div>
          <div class="stat-card">
            <h3>{{ dashboardStats.completedTasks }}</h3>
            <p>Completed</p>
          </div>
          <div class="stat-card">
            <h3>{{ dashboardStats.pendingTasks }}</h3>
            <p>Pending</p>
          </div>
          <div class="stat-card">
            <h3>{{ dashboardStats.inProgressTasks }}</h3>
            <p>In Progress</p>
          </div>
          <div class="stat-card overdue">
            <h3>{{ dashboardStats.overdueTasks }}</h3>
            <p>Overdue</p>
          </div>
        </div>

        <div class="charts-section">
          <div class="chart-card">
            <h4>Tasks by Category</h4>
            <div class="category-list">
              <div *ngFor="let item of dashboardStats.tasksByCategory | keyvalue" class="category-item">
                <span class="category-name">{{ item.key }}</span>
                <span class="category-count">{{ item.value }}</span>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <h4>Tasks by Priority</h4>
            <div class="priority-list">
              <div *ngFor="let item of dashboardStats.tasksByPriority | keyvalue" class="priority-item">
                <span class="priority-name" [class]="getPriorityClass(item.key)">{{ item.key }}</span>
                <span class="priority-count">{{ item.value }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary" (click)="loadDashboardStats()">ğŸ”„ Refresh Stats</button>
    </div>

    <!-- Admin View -->
    <div class="admin-view" *ngIf="currentView === 'admin' && isAdmin">
      <h2>ğŸ‘¥ User Management</h2>
      
      <div class="admin-controls">
        <button class="btn btn-primary" (click)="openUserModal()">â• Add New User</button>
        <button class="btn btn-outline" (click)="loadUsers()">ğŸ”„ Refresh Users</button>
      </div>

      <div class="users-table" *ngIf="users.length > 0">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users">
              <td>{{ user.username }}</td>
              <td>{{ user.email || 'N/A' }}</td>
              <td>
                <span class="role-badge" [class]="'role-' + user.role?.toLowerCase()">
                  {{ user.role }}
                </span>
              </td>
              <td>
                <span class="status-badge" [class.active]="user.isActive">
                  {{ user.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>{{ formatDate(user.createdAt!) }}</td>
              <td class="actions">
                <button class="btn-icon" (click)="openUserModal(user)" title="Edit">âœï¸</button>
                <button class="btn-icon" (click)="deleteUser(user.id!)" title="Delete">ğŸ—‘ï¸</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Task Modal -->
  <div class="modal-overlay" *ngIf="showTaskModal" (click)="closeTaskModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingTask ? 'Edit Task' : 'Create New Task' }}</h3>
        <button class="btn-close" (click)="closeTaskModal()">âœ•</button>
      </div>

      <form (ngSubmit)="saveTask()" #taskForm="ngForm">
        <div class="modal-body">
          <div class="form-group">
            <label for="taskTitle">Title *</label>
            <input 
              type="text" 
              id="taskTitle"
              name="title"
              [(ngModel)]="newTask.title" 
              required
              class="form-control"
              placeholder="Enter task title">
          </div>

          <div class="form-group">
            <label for="taskDescription">Description</label>
            <textarea 
              id="taskDescription"
              name="description"
              [(ngModel)]="newTask.description"
              class="form-control"
              rows="3"
              placeholder="Enter task description"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="taskPriority">Priority</label>
              <select id="taskPriority" name="priority" [(ngModel)]="newTask.priority" class="form-control">
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>

            <div class="form-group">
              <label for="taskStatus">Status</label>
              <select id="taskStatus" name="status" [(ngModel)]="newTask.status" class="form-control">
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="taskCategory">Category</label>
              <select id="taskCategory" name="category" [(ngModel)]="newTask.category" class="form-control">
                <option value="">Select Category</option>
                <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
              </select>
            </div>

            <div class="form-group">
              <label for="taskDueDate">Due Date</label>
              <input 
                type="date" 
                id="taskDueDate"
                name="dueDate"
                [(ngModel)]="newTask.dueDate"
                class="form-control">
            </div>
          </div>

          <div class="form-group">
            <label for="taskTags">Tags (comma-separated)</label>
            <input 
              type="text" 
              id="taskTags"
              name="tags"
              [(ngModel)]="newTask.tags"
              class="form-control"
              placeholder="work, important, urgent">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline" (click)="closeTaskModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading || !taskForm.form.valid">
            <span *ngIf="loading">ğŸ”„ Saving...</span>
            <span *ngIf="!loading">{{ editingTask ? 'ğŸ’¾ Update' : 'â• Create' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal-overlay" *ngIf="showUserModal" (click)="closeUserModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingUser ? 'Edit User' : 'Create New User' }}</h3>
        <button class="btn-close" (click)="closeUserModal()">âœ•</button>
      </div>

      <form (ngSubmit)="saveUser()" #userForm="ngForm">
        <div class="modal-body">
          <div class="form-group">
            <label for="userUsername">Username *</label>
            <input 
              type="text" 
              id="userUsername"
              name="username"
              [(ngModel)]="newUser.username" 
              required
              class="form-control"
              placeholder="Enter username">
          </div>

          <div class="form-group" *ngIf="!editingUser">
            <label for="userPassword">Password *</label>
            <input 
              type="password" 
              id="userPassword"
              name="password"
              [(ngModel)]="newUser.password" 
              required
              class="form-control"
              placeholder="Enter password">
          </div>

          <div class="form-group">
            <label for="userEmail">Email</label>
            <input 
              type="email" 
              id="userEmail"
              name="email"
              [(ngModel)]="newUser.email"
              class="form-control"
              placeholder="Enter email address">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="userFirstName">First Name</label>
              <input 
                type="text" 
                id="userFirstName"
                name="firstName"
                [(ngModel)]="newUser.firstName"
                class="form-control"
                placeholder="Enter first name">
            </div>

            <div class="form-group">
              <label for="userLastName">Last Name</label>
              <input 
                type="text" 
                id="userLastName"
                name="lastName"
                [(ngModel)]="newUser.lastName"
                class="form-control"
                placeholder="Enter last name">
            </div>
          </div>

          <div class="form-group">
            <label for="userRole">Role</label>
            <select id="userRole" name="role" [(ngModel)]="newUser.role" class="form-control">
              <option value="USER">User</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline" (click)="closeUserModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading || !userForm.form.valid">
            <span *ngIf="loading">ğŸ”„ Saving...</span>
            <span *ngIf="!loading">{{ editingUser ? 'ğŸ’¾ Update' : 'â• Create' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-spinner">ğŸ”„ Loading...</div>
  </div>

  <!-- Messages -->
  <div class="message success" *ngIf="successMessage">
    âœ… {{ successMessage }}
  </div>
  
  <div class="message error" *ngIf="error">
    âŒ {{ error }}
  </div>
</div>
